name: release

on:
  workflow_run:
    workflows: ["build"]
    types: [completed]

  workflow_dispatch:

env:
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.daemon=false -Dkotlin.incremental=false"

jobs:
  publish:
    # Only run this job if the workflow was triggered by a successful upstream build workflow,
    # or if it was run manually from the Actions UI.
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    runs-on: macos-latest
    permissions:
      contents: write

    defaults:
       run:
         working-directory: kotlin

    steps:
      - uses: actions/download-artifact@v4
        with:
          name: stoic-release-tar-gz
          path: artifacts

      - uses: actions/checkout@v5

      - uses: actions/setup-java@v5
        with:
          distribution: 'zulu'
          java-version-file: .github/workflows/.java-version

      - name: Read version
        id: version
        run: echo "version=$(cat ../prebuilt/STOIC_VERSION)" >> $GITHUB_OUTPUT

      - name: Verify tag matches STOIC_VERSION
        run: |
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          FILE_VERSION="${{ steps.version.outputs.version }}"
          echo "Tag version: $TAG_VERSION"
          echo "File version: $FILE_VERSION"

          # Allow mismatch only if tag is 'main' and file version ends with '-SNAPSHOT'
          if [ "$TAG_VERSION" != "$FILE_VERSION" ]; then
            if [ "$TAG_VERSION" = "main" ] && [[ "$FILE_VERSION" == *-SNAPSHOT ]]; then
              echo "‚úÖ Tag is 'main' and file version ends with '-SNAPSHOT'; skipping strict check."
            else
              echo "‚ùå Tag ($TAG_VERSION) does not match STOIC_VERSION ($FILE_VERSION)"
              exit 1
            fi
          fi

      - name: Publish to Maven Central
        run: ./gradlew :android:plugin-sdk:publish --info
        env:
          ORG_GRADLE_PROJECT_mavenCentralUsername: ${{ secrets.SONATYPE_CENTRAL_USERNAME }}
          ORG_GRADLE_PROJECT_mavenCentralPassword: ${{ secrets.SONATYPE_CENTRAL_PASSWORD }}
          ORG_GRADLE_PROJECT_signingInMemoryKey: ${{ secrets.GPG_SECRET_KEY }}
          ORG_GRADLE_PROJECT_signingInMemoryKeyPassword: ${{ secrets.GPG_SECRET_PASSPHRASE }}

      - name: Verify JAR inside tarball matches published JAR
        if: ${{ !endsWith(steps.version.outputs.version, '-SNAPSHOT') }}
        run: |
          echo "üß© Extracting jar from stoic-release.tar.gz..."
          tar -xzf artifacts/stoic-release.tar.gz sdk/stoic-android-plugin-sdk.jar

          echo "üß© Computing checksums..."
          shasum -a 256 sdk/stoic-android-plugin-sdk.jar > extracted.sha256
          shasum -a 256 kotlin/android/plugin-sdk/build/libs/*.jar > published.sha256

          echo "Comparing checksums:"
          cat extracted.sha256
          cat published.sha256
          diff -q extracted.sha256 published.sha256 && echo "‚úÖ Matching JARs" || (echo "‚ùå Mismatch!" && exit 1)

      - name: Create GitHub release
        if: ${{ !endsWith(steps.version.outputs.version, '-SNAPSHOT') }}
        run: |
          gh release create ${{ github.ref_name }} \
            artifacts/stoic-release.tar.gz \
            --title "Stoic Release ${{ steps.version.outputs.version }}" \
            --notes "Release bundle including Maven-published JAR and other artifacts."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
